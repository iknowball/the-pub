<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>College Guess - The Pub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://awolvision.com/cdn/shop/articles/sports_bar_awolvision.jpg?v=1713302733&width=1500') !important;
      background-size: cover !important;
      background-position: center !important;
      background-attachment: fixed !important;
      background-color: #451a03 !important;
    }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }
    .font-montserrat {
      font-family: 'Montserrat', sans-serif;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen font-montserrat">
  <header class="w-full max-w-md bg-amber-800/90 text-yellow-300 text-center py-2 border-2 border-yellow-600 rounded-lg mb-4 shadow-lg transform hover:shadow-xl transition duration-200">
    <p class="text-lg font-bold">New Games Daily at 6AM EST</p>
  </header>
  <nav class="w-full max-w-md bg-amber-900/90 p-4 rounded-lg mb-4 border-2 border-yellow-600 shadow-md">
    <div class="flex justify-between">
      <a href="index.html" class="text-yellow-300 hover:text-yellow-400 font-bold">Home</a>
      <a href="news.html" class="text-yellow-300 hover:text-yellow-400 font-bold">Newsstand</a>
      <a href="trivia-game.html" class="text-yellow-300 hover:text-yellow-400 font-bold">NFL Trivia</a>
      <a href="game.html" class="text-yellow-300 hover:text-yellow-400 font-bold">Name That Player</a>
    </div>
  </nav>
  <div id="gameContainer" class="bg-amber-900/90 p-6 rounded-xl shadow-2xl w-full max-w-md border-2 border-yellow-600 relative">
    <div id="timer" class="absolute top-4 left-4 bg-amber-800/90 text-yellow-300 border-2 border-yellow-600 rounded px-2 py-1 text-sm font-bold">00:30</div>
    <h1 class="text-3xl font-bold text-center text-yellow-300 mb-4">College Guess</h1>
    <p class="text-center text-yellow-300 mb-2 text-lg">Level: <span id="currentLevel">1</span>/5</p>
    <p class="text-center text-yellow-300 mb-4 text-lg">Guess the college for <span id="athleteName"></span></p>
    <input id="guessInput" type="text" placeholder="Enter college name..." class="w-full p-3 bg-amber-800/90 text-white border-2 border-yellow-600 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-600" autocomplete="off">
    <button id="submitAnswer" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 font-bold mb-2 border-2 border-yellow-600 shadow-md">Submit Answer</button>
    <button id="nextLevel" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md">Next Level</button>
    <a id="backToHome" href="index.html" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md text-center">Back to Home</a>
    <button id="viewStats" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden mt-2 border-2 border-yellow-600 shadow-md">View Stats</button>
    <p id="feedback" class="text-center mt-4 text-xl font-bold animate-fade-in"></p>
    <p id="score" class="text-center mt-2 text-yellow-300">Score: <span id="scoreValue">0</span>/25</p>
    <p id="shareLink" class="text-center mt-4 hidden text-yellow-300">Share your results: <a id="shareUrl" href="#" class="text-yellow-400 underline"></a></p>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
    <div class="bg-amber-800/90 p-6 rounded-xl w-full max-w-md border-2 border-yellow-600 shadow-lg">
      <h2 class="text-2xl font-bold text-center text-yellow-300 mb-4">Your College Guess Stats</h2>
      <p id="avgScore" class="text-center text-yellow-300 mb-4 text-lg"></p>
      <div class="overflow-x-auto">
        <table class="w-full text-yellow-300 border-collapse">
          <thead>
            <tr class="bg-amber-700/90">
              <th class="p-2 border border-yellow-600">Attempt</th>
              <th class="p-2 border border-yellow-600">Score</th>
              <th class="p-2 border border-yellow-600">Time</th>
              <th class="p-2 border border-yellow-600">Date</th>
            </tr>
          </thead>
          <tbody id="statsTableBody" class="text-center"></tbody>
        </table>
      </div>
      <button id="closeStats" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 font-bold mt-4 border-2 border-yellow-600 shadow-md">Close</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config (replace with your actual config if needed)
    const firebaseConfig = {
      apiKey: "AIzaSyBtsOBlh52YZagsLXp9_dcCq4qhkHBSWnU",
      authDomain: "thepub-sigma.firebaseapp.com",
      projectId: "thepub-sigma",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Helper to get today's date in EST (YYYY-MM-DD) - 6am update
    function getTodayEST6AM() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const est = new Date(utc - 5 * 60 * 60 * 1000);
      if (est.getHours() < 6) {
        est.setDate(est.getDate() - 1);
      }
      return est.toISOString().slice(0, 10);
    }

    async function fetchDailyAthletes() {
      const dateKey = getTodayEST6AM();
      try {
        const doc = await db.collection('dailyCollegeAthletes').doc(dateKey).get();
        if (doc.exists && Array.isArray(doc.data().athletes)) {
          return doc.data().athletes;
        } else {
          alert("No athletes found for today.");
          return [];
        }
      } catch (err) {
        alert("Error fetching today's athletes: " + err.message);
        return [];
      }
    }

    async function startGame() {
      const athletes = await fetchDailyAthletes();
      if (!athletes.length) {
        document.getElementById('gameContainer').innerHTML = "<p class='text-yellow-200'>No athletes available for today.</p>";
        return;
      }

      let currentLevel = 1;
      let score = 0;
      let incorrectColleges = [];
      let timeLeft = 30;
      let timerInterval;

      function getLevenshteinDistance(a, b) {
        const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j - 1][i] + 1,
              matrix[j][i - 1] + 1,
              matrix[j - 1][i - 1] + cost
            );
          }
        }
        return matrix[b.length][a.length];
      }

      function startTimer() {
        timeLeft = 30;
        timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            feedback.textContent = `Time's up! The college was ${athletes[currentLevel - 1].college}.`;
            feedback.classList.add('text-red-500');
            incorrectColleges.push(athletes[currentLevel - 1].college);
            submitAnswer.classList.add('hidden');
            guessInput.classList.add('hidden');
            nextLevel.classList.remove('hidden');
            showStats();
          }
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        return 30 * athletes.length - timeLeft;
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
      }

      // DOM elements
      const gameContainer = document.getElementById('gameContainer');
      const athleteName = document.getElementById('athleteName');
      const guessInput = document.getElementById('guessInput');
      const submitAnswer = document.getElementById('submitAnswer');
      const nextLevel = document.getElementById('nextLevel');
      const backToHome = document.getElementById('backToHome');
      const viewStats = document.getElementById('viewStats');
      const feedback = document.getElementById('feedback');
      const scoreDisplay = document.getElementById('scoreValue');
      const currentLevelDisplay = document.getElementById('currentLevel');
      const shareLink = document.getElementById('shareLink');
      const shareUrl = document.getElementById('shareUrl');
      const statsModal = document.getElementById('statsModal');
      const avgScore = document.getElementById('avgScore');
      const statsTableBody = document.getElementById('statsTableBody');
      const closeStats = document.getElementById('closeStats');
      const timerDisplay = document.getElementById('timer');

      function getScoreHistory() {
        return JSON.parse(localStorage.getItem('collegeGameHistory') || '[]');
      }

      function saveScoreHistory(score, time) {
        const history = getScoreHistory();
        history.push({
          score: score,
          time: time,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('collegeGameHistory', JSON.stringify(history));
      }

      function calculateAverageScore() {
        const history = getScoreHistory();
        if (history.length === 0) return 0;
        const total = history.reduce((sum, entry) => sum + entry.score, 0);
        return (total / history.length).toFixed(1);
      }

      function displayStats() {
        const history = getScoreHistory();
        avgScore.textContent = `Average Score: ${calculateAverageScore()}/25`;
        statsTableBody.innerHTML = '';
        history.forEach((entry, index) => {
          const row = document.createElement('tr');
          row.classList.add('hover:bg-amber-600');
          row.innerHTML = `
            <td class="p-2 border border-yellow-600">${index + 1}</td>
            <td class="p-2 border border-yellow-600">${entry.score}/25</td>
            <td class="p-2 border border-yellow-600">${formatTime(entry.time)}</td>
            <td class="p-2 border border-yellow-600">${new Date(entry.timestamp).toLocaleString()}</td>
          `;
          statsTableBody.appendChild(row);
        });
        statsModal.classList.remove('hidden');
      }

      function generateShareLink(score, incorrectColleges) {
        const baseUrl = 'https://thepub-sigma.vercel.app/college-game';
        const incorrectParam = incorrectColleges.map(name => encodeURIComponent(name)).join(',');
        return `${baseUrl}?score=${score}&incorrect=${incorrectParam}`;
      }

      function displayResultsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const score = urlParams.get('score');
        const incorrect = urlParams.get('incorrect');
        if (score !== null) {
          let incorrectMessage = "I knew all the colleges! üèÜ";
          if (incorrect) {
            const incorrectList = incorrect.split(',').map(name => decodeURIComponent(name)).join(', ');
            incorrectMessage = `I missed ${incorrectList}.`;
          }
          gameContainer.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-yellow-300 mb-4">College Guess Results</h1>
            <p class="text-center mb-4 text-yellow-300 text-xl">Score: ${score}/25 üèà</p>
            <p class="text-center mb-4 text-yellow-300">${incorrectMessage}</p>
            <p class="text-center"><a href="index.html" class="text-yellow-400 underline text-lg">Back to Home</a></p>
          `;
        }
      }

      function loadLevel() {
        athleteName.textContent = athletes[currentLevel - 1].name;
        guessInput.value = '';
        feedback.textContent = '';
        submitAnswer.classList.remove('hidden');
        guessInput.classList.remove('hidden');
        nextLevel.classList.add('hidden');
        backToHome.classList.add('hidden');
        viewStats.classList.add('hidden');
        shareLink.classList.add('hidden');
        scoreDisplay.textContent = score;
        currentLevelDisplay.textContent = currentLevel;
        startTimer();
      }

      function showStats() {
        const stats = document.createElement('p');
        stats.classList.add('text-yellow-300', 'text-center', 'mb-4');
        stats.textContent = athletes[currentLevel - 1].stats;
        statsModal.querySelector('div').insertBefore(stats, statsModal.querySelector('p#avgScore'));
        statsModal.classList.remove('hidden');
      }

      function moveToNextLevel() {
        currentLevel++;
        statsModal.querySelector('p.text-yellow-300.text-center.mb-4')?.remove();
        if (currentLevel <= athletes.length) {
          loadLevel();
        } else {
          const finalTime = stopTimer();
          saveScoreHistory(score, finalTime);
          feedback.textContent = `Game Over! Your Score: ${score}/25 üèÜ`;
          feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
          feedback.classList.add('text-yellow-300');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.add('hidden');
          backToHome.classList.remove('hidden');
          viewStats.classList.remove('hidden');
          const shareUrlLink = generateShareLink(score, incorrectColleges);
          shareUrl.href = shareUrlLink;
          shareUrl.textContent = `üèà My Score: ${score}/25 ${incorrectColleges.length ? '| Missed: ' + incorrectColleges.join(', ') : '| Nailed all colleges!'}`;
          shareLink.classList.remove('hidden');
        }
      }

      submitAnswer.addEventListener('click', () => {
        const guess = guessInput.value.trim().toLowerCase();
        const correctCollege = athletes[currentLevel - 1].college.toLowerCase();

        feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
        if (guess === correctCollege) {
          score += 5;
          feedback.textContent = `Nailed it! +5 points! üèÄ`;
          feedback.classList.add('text-green-500');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.remove('hidden');
          stopTimer();
          showStats();
        } else {
          const distance = getLevenshteinDistance(guess, correctCollege);
          if (distance <= 2 && guess.length > 0) {
            feedback.textContent = `So close! Try again, you're off by a letter or two!`;
            feedback.classList.add('text-yellow-400');
            guessInput.value = '';
          } else {
            incorrectColleges.push(athletes[currentLevel - 1].college);
            feedback.textContent = `Swing and a miss! It was ${athletes[currentLevel - 1].college}.`;
            feedback.classList.add('text-red-500');
            submitAnswer.classList.add('hidden');
            guessInput.classList.add('hidden');
            nextLevel.classList.remove('hidden');
            stopTimer();
            showStats();
          }
        }
        scoreDisplay.textContent = score;
      });

      guessInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitAnswer.click();
      });

      nextLevel.addEventListener('click', () => {
        moveToNextLevel();
      });

      viewStats.addEventListener('click', () => {
        displayStats();
      });

      closeStats.addEventListener('click', () => {
        statsModal.classList.add('hidden');
        if (currentLevel <= athletes.length) {
          moveToNextLevel();
        }
      });

      loadLevel();

      displayResultsFromUrl();
    }

    document.addEventListener("DOMContentLoaded", startGame);
  </script>
</body>
</html>
