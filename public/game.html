<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guess the Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://awolvision.com/cdn/shop/articles/sports_bar_awolvision.jpg?v=1713302733&width=1500') !important;
      background-size: cover !important;
      background-position: center !important;
      background-attachment: fixed !important;
      background-color: #451a03 !important;
    }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }
    .font-montserrat {
      font-family: 'Montserrat', sans-serif;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen font-montserrat">
  <header class="w-full max-w-md bg-amber-800/90 text-yellow-300 text-center py-2 border-2 border-yellow-600 rounded-lg mb-4 shadow-lg transform hover:shadow-xl transition duration-200">
    <p class="text-lg font-bold">New Games Daily at Midnight EST</p>
  </header>
  <div id="gameContainer" class="bg-amber-900/90 p-6 rounded-xl shadow-2xl w-full max-w-md border-2 border-yellow-600 relative">
    <!-- TIMER MOVED: Remove the absolute-positioned timer above -->
    <div class="flex flex-wrap gap-2 justify-center mb-4">
      <a href="index.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">Home</a>
      <a href="news.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">News</a>
      <a href="trivia-game.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">Trivia</a>
      <a href="college-game.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">College</a>
    </div>
    <h1 class="text-3xl font-bold text-center text-yellow-300 mb-4">Who is This?</h1>
    <p class="text-center text-yellow-300 mb-2 text-lg">Level: <span id="currentLevel">1</span>/5</p>
    <div class="relative w-full h-72 mb-4 rounded-lg overflow-hidden border-2 border-yellow-600">
      <img id="playerImage" src="" alt="Athlete" class="w-full h-full object-cover">
      <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
    </div>
    <p id="imageError" class="text-center mb-4 text-red-500 hidden">Image failed to load. Keep guessing!</p>
    <input id="guessInput" type="text" placeholder="Who's this athlete?" class="w-full p-3 bg-amber-800/90 text-white border-2 border-yellow-600 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-600" autocomplete="off">
    <button id="submitAnswer" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 font-bold mb-2 border-2 border-yellow-600 shadow-md">Submit Answer</button>
    <button id="nextLevel" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md">Next Level</button>
    <a id="backToHome" href="index.html" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md text-center">Back to Home</a>
    <button id="viewStats" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden mt-2 border-2 border-yellow-600 shadow-md">View Stats</button>
    <p id="feedback" class="text-center mt-4 text-xl font-bold animate-fade-in"></p>
    <!-- TIMER AND SCORE BAR (timer left of score) -->
    <div class="flex flex-row items-center justify-center gap-4 mt-4">
      <div id="timer" class="bg-amber-800/90 text-yellow-300 border-2 border-yellow-600 rounded px-2 py-1 text-sm font-bold">00:00</div>
      <p id="score" class="text-yellow-300 text-center mb-0">Score: <span id="scoreValue">0</span>/25</p>
    </div>
    <p id="shareLink" class="text-center mt-4 hidden text-yellow-300">Share your results: <a id="shareUrl" href="#" class="text-yellow-400 underline"></a></p>
  </div>
  <!-- Stats Modal -->
  <div id="statsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
    <div class="bg-amber-800/90 p-6 rounded-xl w-full max-w-md border-2 border-yellow-600 shadow-lg">
      <h2 class="text-2xl font-bold text-center text-yellow-300 mb-4">Your Pub Quiz Stats</h2>
      <p id="avgScore" class="text-center text-yellow-300 mb-4 text-lg"></p>
      <div class="overflow-x-auto">
        <table class="w-full text-yellow-300 border-collapse">
          <thead>
            <tr class="bg-amber-700/90">
              <th class="p-2 border border-yellow-600">Attempt</th>
              <th class="p-2 border border-yellow-600">Score</th>
              <th class="p-2 border border-yellow-600">Time</th>
              <th class="p-2 border border-yellow-600">Date</th>
            </tr>
          </thead>
          <tbody id="statsTableBody" class="text-center"></tbody>
        </table>
      </div>
      <button id="closeStats" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 font-bold mt-4 border-2 border-yellow-600 shadow-md">Close</button>
    </div>
  </div>
  <!-- Firebase SDKs (ORDER IS IMPORTANT!) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBtsOBlh52YZagsLXp9_dcCq4qhkHBSWnU",
      authDomain: "thepub-sigma.firebaseapp.com",
      projectId: "thepub-sigma",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Helper: get current user (anonymous if not signed in)
    function getCurrentUserId() {
      const user = auth.currentUser;
      if (user) {
        return user.uid;
      }
      // Fallback to localStorage for anonymous stats
      let anonId = localStorage.getItem('anonUserId');
      if (!anonId) {
        anonId = 'anon-' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('anonUserId', anonId);
      }
      return anonId;
    }

    // Record score for every completed game (regardless of authentication)
    async function recordGameScore(score, time) {
      try {
        const userId = getCurrentUserId();
        const today = new Date().toISOString().slice(0, 10);
        await db.collection('gameScores').add({
          userId: userId,
          score: score,
          time: time,
          playedAt: new Date().toISOString()
        });
        // Update user's average score in a separate collection
        await updateUserAverageScore(userId);
      } catch (err) {
        console.error("Error recording game score:", err);
      }
    }

    // Update average score for a user
    async function updateUserAverageScore(userId) {
      try {
        // Get all scores for the user
        const scoresSnap = await db.collection('gameScores').where('userId', '==', userId).get();
        let total = 0;
        let count = 0;
        scoresSnap.forEach(doc => {
          total += doc.data().score;
          count += 1;
        });
        const avg = count === 0 ? 0 : (total / count);
        // Store in userAverages collection
        await db.collection('userAverages').doc(userId).set({
          userId: userId,
          averageScore: avg,
          lastUpdated: new Date().toISOString(),
          gamesPlayed: count
        });
      } catch (err) {
        console.error("Error updating user average score:", err);
      }
    }

    // Fetch user average score from Firestore
    async function fetchUserAverageScore(userId) {
      try {
        const doc = await db.collection('userAverages').doc(userId).get();
        if (doc.exists) {
          return doc.data().averageScore;
        }
        return null;
      } catch (err) {
        console.error("Failed to fetch user average score:", err);
        return null;
      }
    }

    // Helper to get today's date in EST (YYYY-MM-DD) - 6am update
    function getTodayEasternMidnight() {
    // Get current time in America/New_York (EST/EDT depending on time of year)
      const now = new Date();
      const eastern = new Date(
        now.toLocaleString("en-US", { timeZone: "America/New_York" })
      );
      if (eastern.getHours() > 0) {
        eastern.setDate(eastern.getDate() - 1);
      }
      return eastern.toISOString().slice(0, 10);
    }

    async function fetchDailyPlayers() {
      const dateKey = getTodayEasternMidnight();
      try {
        const doc = await db.collection('dailyPlayers').doc(dateKey).get();
        if (doc.exists && Array.isArray(doc.data().players)) {
          return doc.data().players;
        } else {
          alert("No daily players found for today.");
          return [];
        }
      } catch (err) {
        alert("Error fetching today's players: " + err.message);
        return [];
      }
    }

    async function startGame() {
      const dailyPlayers = await fetchDailyPlayers();
      if (!dailyPlayers.length) {
        document.getElementById('gameContainer').innerHTML = "<p class='text-yellow-200'>No players available for today.</p>";
        return;
      }

      let currentLevel = 1;
      let score = 0;
      let correctAnswers = 0;
      let incorrectAthletes = [];
      let startTime = null;
      let elapsedTime = 0;
      let timerInterval;

      function getLevenshteinDistance(a, b) {
        const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j - 1][i] + 1,
              matrix[j][i - 1] + 1,
              matrix[j - 1][i - 1] + cost
            );
          }
        }
        return matrix[b.length][a.length];
      }
      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
      }
      function updateTimer() {
        elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
        const seconds = (elapsedTime % 60).toString().padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
      }
      function stopTimer() {
        clearInterval(timerInterval);
        return elapsedTime;
      }
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
      }
      // DOM elements
      const gameContainer = document.getElementById('gameContainer');
      const playerImage = document.getElementById('playerImage');
      const imageError = document.getElementById('imageError');
      const guessInput = document.getElementById('guessInput');
      const submitAnswer = document.getElementById('submitAnswer');
      const nextLevel = document.getElementById('nextLevel');
      const backToHome = document.getElementById('backToHome');
      const viewStats = document.getElementById('viewStats');
      const feedback = document.getElementById('feedback');
      const scoreDisplay = document.getElementById('scoreValue');
      const currentLevelDisplay = document.getElementById('currentLevel');
      const shareLink = document.getElementById('shareLink');
      const shareUrl = document.getElementById('shareUrl');
      const statsModal = document.getElementById('statsModal');
      const avgScore = document.getElementById('avgScore');
      const statsTableBody = document.getElementById('statsTableBody');
      const closeStats = document.getElementById('closeStats');
      const timerDisplay = document.getElementById('timer');
      function getScoreHistory() {
        return JSON.parse(localStorage.getItem('scoreHistory') || '[]');
      }
      function saveScoreHistory(score, time) {
        const history = getScoreHistory();
        history.push({
          score: score,
          time: time,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('scoreHistory', JSON.stringify(history));
      }
      function calculateAverageScore() {
        const history = getScoreHistory();
        if (history.length === 0) return 0;
        const total = history.reduce((sum, entry) => sum + entry.score, 0);
        return (total / history.length).toFixed(1);
      }

      // Fetch and display stats from Firestore (average score)
      async function displayStats() {
        const history = getScoreHistory();
        const userId = getCurrentUserId();
        let avgFromCloud = await fetchUserAverageScore(userId);
        if (avgFromCloud !== null) {
          avgScore.textContent = `Average Score (cloud): ${avgFromCloud.toFixed(1)}/25`;
        } else {
          avgScore.textContent = `Average Score (local): ${calculateAverageScore()}/25`;
        }
        statsTableBody.innerHTML = '';
        history.forEach((entry, index) => {
          const row = document.createElement('tr');
          row.classList.add('hover:bg-amber-600');
          row.innerHTML = `
            <td class="p-2 border border-yellow-600">${index + 1}</td>
            <td class="p-2 border border-yellow-600">${entry.score}/25</td>
            <td class="p-2 border border-yellow-600">${formatTime(entry.time)}</td>
            <td class="p-2 border border-yellow-600">${new Date(entry.timestamp).toLocaleString()}</td>
          `;
          statsTableBody.appendChild(row);
        });
        statsModal.classList.remove('hidden');
      }
      // Handle image load errors
      playerImage.onerror = () => {
        imageError.classList.remove('hidden');
        submitAnswer.classList.remove('hidden');
        nextLevel.classList.add('hidden');
      };
      playerImage.onload = () => {
        imageError.classList.add('hidden');
        submitAnswer.classList.remove('hidden');
        nextLevel.classList.add('hidden');
      };
      function generateShareLink(score, incorrectAthletes) {
        const baseUrl = 'https://thepub-sigma.vercel.app/game';
        const incorrectParam = incorrectAthletes.map(name => encodeURIComponent(name)).join(',');
        return `${baseUrl}?score=${score}&incorrect=${incorrectParam}`;
      }
      function displayResultsFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const score = urlParams.get('score');
        const incorrect = urlParams.get('incorrect');
        if (score !== null) {
          let incorrectMessage = "I knew all the athletes! 🏆";
          if (incorrect) {
            const incorrectList = incorrect.split(',').map(name => decodeURIComponent(name)).join(', ');
            incorrectMessage = `I did not know ${incorrectList}.`;
          }
          gameContainer.innerHTML = `
            <h1 class="text-3xl font-bold text-center text-yellow-300 mb-4">Pub Quiz Results</h1>
            <p class="text-center mb-4 text-yellow-300 text-xl">Score: ${score}/25 🏈</p>
            <p class="text-center mb-4 text-yellow-300">${incorrectMessage}</p>
            <p class="text-center"><a href="index.html" class="text-yellow-400 underline text-lg">Back to Home</a></p>
          `;
        }
      }
      function loadLevel() {
        playerImage.src = dailyPlayers[currentLevel - 1].image;
        guessInput.value = '';
        feedback.textContent = '';
        submitAnswer.classList.remove('hidden');
        guessInput.classList.remove('hidden');
        nextLevel.classList.add('hidden');
        backToHome.classList.add('hidden');
        viewStats.classList.add('hidden');
        imageError.classList.add('hidden');
        scoreDisplay.textContent = score;
        currentLevelDisplay.textContent = currentLevel;
        shareLink.classList.add('hidden');
        if (currentLevel === 1 && !startTime) {
          startTimer();
        }
      }
      async function moveToNextLevel() {
        currentLevel++;
        if (currentLevel <= dailyPlayers.length) {
          loadLevel();
        } else {
          const finalTime = stopTimer();
          saveScoreHistory(score, finalTime);

          // Record score in Firestore for every completed game and update average
          await recordGameScore(score, finalTime);

          feedback.textContent = `Game Over! Your Score: ${score}/25 🏆`;
          feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
          feedback.classList.add('text-yellow-300');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.add('hidden');
          backToHome.classList.remove('hidden');
          viewStats.classList.remove('hidden');
          const shareUrlLink = generateShareLink(score, incorrectAthletes);
          shareUrl.href = shareUrlLink;
          shareUrl.textContent = `🏈 My Score: ${score}/25 ${incorrectAthletes.length ? '| Missed: ' + incorrectAthletes.join(', ') : '| Nailed all athletes!'}`;
          shareLink.classList.remove('hidden');
        }
      }
      submitAnswer.addEventListener('click', () => {
        const guess = guessInput.value.trim().toLowerCase();
        const correctName = dailyPlayers[currentLevel - 1].name.toLowerCase();
        feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
        if (guess === correctName) {
          score += 5;
          correctAnswers += 1;
          feedback.textContent = `Nailed it! +5 points! 🏀`;
          feedback.classList.add('text-green-500');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.remove('hidden');
        } else {
          const distance = getLevenshteinDistance(guess, correctName);
          if (distance <= 2 && guess.length > 0) {
            feedback.textContent = `So close! Try again, you're off by a letter or two!`;
            feedback.classList.add('text-yellow-400');
            guessInput.value = '';
          } else {
            incorrectAthletes.push(dailyPlayers[currentLevel - 1].name);
            feedback.textContent = `Swing and a miss! It was ${dailyPlayers[currentLevel - 1].name}.`;
            feedback.classList.add('text-red-500');
            submitAnswer.classList.add('hidden');
            guessInput.classList.add('hidden');
            nextLevel.classList.remove('hidden');
          }
        }
        scoreDisplay.textContent = score;
        if (currentLevel === dailyPlayers.length && (guess === correctName || getLevenshteinDistance(guess, correctName) > 2)) {
          stopTimer();
        }
      });
      nextLevel.addEventListener('click', () => {
        moveToNextLevel();
      });
      viewStats.addEventListener('click', () => {
        displayStats();
      });
      closeStats.addEventListener('click', () => {
        statsModal.classList.add('hidden');
      });
      loadLevel();
      displayResultsFromUrl();
    }

    // Start game on DOMContentLoaded
    document.addEventListener("DOMContentLoaded", () => {
      // Try to sign in anonymously for user tracking
      auth.onAuthStateChanged(user => {
        if (!user) {
          auth.signInAnonymously()
            .catch(() => {}); // Ignore errors; fallback to localStorage id
        }
        // Always start game after auth state checked
        startGame();
      });
    });
  </script>
</body>
</html>
