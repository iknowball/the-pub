<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFL Trivia - The Pub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://awolvision.com/cdn/shop/articles/sports_bar_awolvision.jpg?v=1713302733&width=1500') !important;
      background-size: cover !important;
      background-position: center !important;
      background-attachment: fixed !important;
      background-color: #451a03 !important;
    }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }
    .font-montserrat {
      font-family: 'Montserrat', sans-serif;
    }
    .share-buttons-row {
      display: flex;
      flex-direction: row;
      gap: 14px;
      justify-content: center;
      align-items: center;
    }
    .clipboard-btn, .sms-btn {
      background: #f9e38f;
      color: #533e1f;
      font-weight: bold;
      border-radius: 8px;
      border: 2px solid #cfb467;
      padding: 7px 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px #cfb46733;
      margin-top: 8px;
      margin-bottom: 8px;
      transition: background 0.2s, color 0.2s;
      display: inline-block;
    }
    .clipboard-btn:hover, .sms-btn:hover {
      background: #fffbe7;
      color: #b88340;
    }
    .share-preview {
      font-size: 1.15rem;
      color: #f9e38f;
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 6px;
      text-align: center;
      word-break: break-word;
    }
    .share-link-ball {
      color: #ffd700;
      text-decoration: underline;
      font-size: 1.15rem;
      font-weight: bold;
      margin-left: 6px;
      cursor: pointer;
    }
    .share-link-ball:hover {
      color: #ffbb33;
      text-decoration: underline;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen font-montserrat">
  <header class="w-full max-w-md bg-amber-800/90 text-yellow-300 text-center py-2 border-2 border-yellow-600 rounded-lg mb-4 shadow-lg transform hover:shadow-xl transition duration-200">
    <p class="text-lg font-bold">New Games Daily at Midnight Eastern</p>
  </header>
  <div id="gameContainer" class="bg-amber-900/90 p-6 rounded-xl shadow-2xl w-full max-w-md border-2 border-yellow-600 relative">
    <div class="flex flex-wrap gap-2 justify-center mb-4">
      <a href="index.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">Home</a>
      <a href="news.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">News</a>
      <a href="game.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">Players</a>
      <a href="college-game.html" class="flex-1 bg-amber-600 text-white font-bold p-2 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 border-2 border-yellow-600 shadow-md text-center">College</a>
    </div>
    <h1 class="text-3xl font-bold text-center text-yellow-300 mb-4">Trivia</h1>
    <p class="text-center text-yellow-300 mb-2 text-lg">Question: <span id="currentLevel">1</span>/5</p>
    <p class="text-center text-yellow-300 mb-4 text-lg" id="questionText"></p>
    <input id="guessInput" type="text" placeholder="Enter your answer..." class="w-full p-3 bg-amber-800/90 text-white border-2 border-yellow-600 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-600" autocomplete="off">
    <button id="submitAnswer" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 transform hover:scale-105 transition duration-200 font-bold mb-2 border-2 border-yellow-600 shadow-md">Submit Answer</button>
    <button id="nextLevel" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md">Next Question</button>
    <a id="backToHome" href="index.html" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden border-2 border-yellow-600 shadow-md text-center">Back to Home</a>
    <button id="viewStats" class="w-full bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transform hover:scale-105 transition duration-200 font-bold hidden mt-2 border-2 border-yellow-600 shadow-md">View Stats</button>
    <p id="feedback" class="text-center mt-4 text-xl font-bold animate-fade-in"></p>
    <div class="flex flex-row items-center justify-center gap-4 mt-4">
      <div id="timer" class="bg-amber-800/90 text-yellow-300 border-2 border-yellow-600 rounded px-2 py-1 text-sm font-bold">00:00</div>
      <p id="score" class="text-yellow-300 text-center mb-0">Score: <span id="scoreValue">0</span>/25</p>
    </div>
    <div id="shareLink" class="text-center mt-4 hidden text-yellow-300">
      <div class="share-buttons-row">
        <button id="clipboardBtn" class="clipboard-btn">Copy to Clipboard</button>
        <a id="smsBtn" class="sms-btn" href="#" target="_blank">Send as SMS</a>
      </div>
      <div id="sharePreview" class="share-preview"></div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
    <div class="bg-amber-800/90 p-6 rounded-xl w-full max-w-md border-2 border-yellow-600 shadow-lg">
      <h2 class="text-2xl font-bold text-center text-yellow-300 mb-4">Your NFL Trivia Stats</h2>
      <p id="avgScore" class="text-center text-yellow-300 mb-4 text-lg"></p>
      <div class="overflow-x-auto">
        <table class="w-full text-yellow-300 border-collapse">
          <thead>
            <tr class="bg-amber-700/90">
              <th class="p-2 border border-yellow-600">Attempt</th>
              <th class="p-2 border border-yellow-600">Score</th>
              <th class="p-2 border border-yellow-600">Time</th>
              <th class="p-2 border border-yellow-600">Date</th>
            </tr>
          </thead>
          <tbody id="statsTableBody" class="text-center"></tbody>
        </table>
      </div>
      <button id="closeStats" class="w-full bg-amber-600 text-white p-3 rounded-lg hover:bg-amber-700 font-bold mt-4 border-2 border-yellow-600 shadow-md">Close</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBtsOBlh52YZagsLXp9_dcCq4qhkHBSWnU",
      authDomain: "thepub-sigma.firebaseapp.com",
      projectId: "thepub-sigma",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- NFL Trivia Questions Generator ---
    const NFL_QUESTION_POOL = [
      { question: "Which team won the Super Bowl in 2010?", answer: "Saints" },
      { question: "Who was the NFL MVP in 2018?", answer: "Patrick Mahomes" },
      { question: "Which QB threw a 99-yard touchdown pass in 2011?", answer: "Matt Stafford" },
      { question: "Which player holds the record for most career sacks?", answer: "Bruce Smith" },
      { question: "Who was the first overall pick in the 2020 NFL Draft?", answer: "Joe Burrow" },
      { question: "Which stadium do the Seattle Seahawks play in?", answer: "Lumen Field" },
      { question: "Who was the coach of the Patriots for their first Super Bowl win?", answer: "Bill Belichick" },
      { question: "Which team has the most Super Bowl appearances?", answer: "Patriots" },
      { question: "Which running back had a 2,000 yard season in 2009?", answer: "Chris Johnson" },
      { question: "Which kicker hit the double-doink in the playoffs?", answer: "Cody Parkey" },
      { question: "Who was the 'Steel Curtain' defense's leader in the 1970s?", answer: "Mean Joe Greene" },
      { question: "Which NFL team was featured in 'Hard Knocks' in 2023?", answer: "Jets" },
      { question: "Who caught the helmet catch in Super Bowl XLII?", answer: "David Tyree" },
      { question: "Which QB started for the Eagles in the 2018 Super Bowl?", answer: "Nick Foles" },
      { question: "Which wide receiver was known as 'Megatron'?", answer: "Calvin Johnson" },
      { question: "Who led the NFL in rushing yards in 2016?", answer: "Ezekiel Elliott" },
    ];

    function getEasternMidnightDateKey() {
      const now = new Date();
      const nyString = now.toLocaleString("en-US", { timeZone: "America/New_York" });
      const nyDate = new Date(nyString);
      nyDate.setHours(0,0,0,0);
      return nyDate.toISOString().slice(0, 10);
    }

    async function getOrGenerateDailyQuestions() {
      const dateKey = getEasternMidnightDateKey();
      const docRef = db.collection('dailyTrivia').doc(dateKey);
      const doc = await docRef.get();
      if (doc.exists && Array.isArray(doc.data().questions)) {
        return doc.data().questions;
      } else {
        const shuffled = NFL_QUESTION_POOL.sort(() => 0.5 - Math.random());
        const questions = shuffled.slice(0, 5);
        await docRef.set({ questions: questions });
        return questions;
      }
    }

    async function fetchDailyQuestions() {
      return await getOrGenerateDailyQuestions();
    }

    function getCurrentUserId() {
      const user = auth.currentUser;
      if (user) {
        return user.uid;
      }
      let anonId = localStorage.getItem('anonUserId');
      if (!anonId) {
        anonId = 'anon-' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('anonUserId', anonId);
      }
      return anonId;
    }

    async function recordTriviaGameScore(score, time) {
      try {
        const userId = getCurrentUserId();
        await db.collection('triviaGameScores').add({
          userId: userId,
          score: score,
          time: time,
          playedAt: new Date().toISOString()
        });
        await updateTriviaAverageScore(userId);
      } catch (err) {
        console.error("Error recording trivia game score:", err);
      }
    }

    async function updateTriviaAverageScore(userId) {
      try {
        const scoresSnap = await db.collection('triviaGameScores').where('userId', '==', userId).get();
        let total = 0;
        let count = 0;
        scoresSnap.forEach(doc => {
          total += doc.data().score;
          count += 1;
        });
        const avg = count === 0 ? 0 : (total / count);
        await db.collection('triviaAverages').doc(userId).set({
          userId: userId,
          averageScore: avg,
          lastUpdated: new Date().toISOString(),
          gamesPlayed: count
        });
      } catch (err) {
        console.error("Error updating trivia average score:", err);
      }
    }

    async function fetchTriviaAverageScore(userId) {
      try {
        const doc = await db.collection('triviaAverages').doc(userId).get();
        if (doc.exists) {
          return doc.data().averageScore;
        }
        return null;
      } catch (err) {
        console.error("Failed to fetch user trivia average score:", err);
        return null;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      auth.onAuthStateChanged(user => {
        if (!user) {
          auth.signInAnonymously()
            .catch(() => {});
        }
        startGame();
      });
    });

    async function startGame() {
      const questions = await fetchDailyQuestions();

      let currentLevel = 1;
      let score = 0;
      let answerResults = [];
      let elapsedTime = 0;
      let timerInterval;

      function getLevenshteinDistance(a, b) {
        const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
        for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
        for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
        for (let j = 1; j <= b.length; j++) {
          for (let i = 1; i <= a.length; i++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
              matrix[j - 1][i] + 1,
              matrix[j][i - 1] + 1,
              matrix[j - 1][i - 1] + cost
            );
          }
        }
        return matrix[b.length][a.length];
      }

      function startTimer() {
        elapsedTime = 0;
        timerDisplay.textContent = `00:00`;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          elapsedTime++;
          const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
          const seconds = (elapsedTime % 60).toString().padStart(2, '0');
          timerDisplay.textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        return elapsedTime;
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
      }

      const gameContainer = document.getElementById('gameContainer');
      const questionText = document.getElementById('questionText');
      const guessInput = document.getElementById('guessInput');
      const submitAnswer = document.getElementById('submitAnswer');
      const nextLevel = document.getElementById('nextLevel');
      const backToHome = document.getElementById('backToHome');
      const viewStats = document.getElementById('viewStats');
      const feedback = document.getElementById('feedback');
      const scoreDisplay = document.getElementById('scoreValue');
      const currentLevelDisplay = document.getElementById('currentLevel');
      const shareLink = document.getElementById('shareLink');
      const sharePreview = document.getElementById('sharePreview');
      const clipboardBtn = document.getElementById('clipboardBtn');
      const smsBtn = document.getElementById('smsBtn');
      const statsModal = document.getElementById('statsModal');
      const avgScore = document.getElementById('avgScore');
      const statsTableBody = document.getElementById('statsTableBody');
      const closeStats = document.getElementById('closeStats');
      const timerDisplay = document.getElementById('timer');

      function getScoreHistory() {
        return JSON.parse(localStorage.getItem('triviaGameHistory') || '[]');
      }

      function saveScoreHistory(score, time) {
        const history = getScoreHistory();
        history.push({
          score: score,
          time: time,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('triviaGameHistory', JSON.stringify(history));
      }

      function calculateAverageScore() {
        const history = getScoreHistory();
        if (history.length === 0) return 0;
        const total = history.reduce((sum, entry) => sum + entry.score, 0);
        return (total / history.length).toFixed(1);
      }

      async function displayStats() {
        const history = getScoreHistory();
        const userId = getCurrentUserId();
        let avgFromCloud = await fetchTriviaAverageScore(userId);
        if (avgFromCloud !== null) {
          avgScore.textContent = `Average Score (cloud): ${avgFromCloud.toFixed(1)}/25`;
        } else {
          avgScore.textContent = `Average Score (local): ${calculateAverageScore()}/25`;
        }
        statsTableBody.innerHTML = '';
        history.forEach((entry, index) => {
          const row = document.createElement('tr');
          row.classList.add('hover:bg-amber-600');
          row.innerHTML = `
            <td class="p-2 border border-yellow-600">${index + 1}</td>
            <td class="p-2 border border-yellow-600">${entry.score}/25</td>
            <td class="p-2 border border-yellow-600">${formatTime(entry.time)}</td>
            <td class="p-2 border border-yellow-600">${new Date(entry.timestamp).toLocaleString()}</td>
          `;
          statsTableBody.appendChild(row);
        });
        statsModal.classList.remove('hidden');
      }

      // Emoji share logic
      function generateEmojiShareMessage(results) {
        const emojis = results.map(r => r ? '✅' : '❌');
        while (emojis.length < 5) emojis.push('❓');
        return emojis.join('');
      }
      function generateShareText(results) {
        const homepage = window.location.origin + "/trivia-game.html";
        const emojiMsg = generateEmojiShareMessage(results);
        return `${emojiMsg} <a href="${homepage}" class="share-link-ball" target="_blank">Do you know ball?</a>`;
      }
      function generateClipboardText(results) {
        const homepage = window.location.origin + "/trivia-game.html";
        const emojiMsg = generateEmojiShareMessage(results);
        return `${emojiMsg} Do you know ball? ${homepage}`;
      }
      function generateSmsLink(results) {
        const homepage = window.location.origin + "/trivia-game.html";
        const emojiMsg = generateEmojiShareMessage(results);
        const msg = `${emojiMsg} Do you know ball? ${homepage}`;
        return "sms:?body=" + encodeURIComponent(msg);
      }

      function loadLevel() {
        questionText.textContent = questions[currentLevel - 1].question;
        guessInput.value = '';
        feedback.textContent = '';
        submitAnswer.classList.remove('hidden');
        guessInput.classList.remove('hidden');
        nextLevel.classList.add('hidden');
        backToHome.classList.add('hidden');
        viewStats.classList.add('hidden');
        shareLink.classList.add('hidden');
        scoreDisplay.textContent = score;
        currentLevelDisplay.textContent = currentLevel;
        startTimer();
      }

      async function moveToNextLevel() {
        currentLevel++;
        statsModal.querySelector('p.text-yellow-300.text-center.mb-4')?.remove();
        if (currentLevel <= questions.length) {
          loadLevel();
        } else {
          const finalTime = stopTimer();
          saveScoreHistory(score, finalTime);
          await recordTriviaGameScore(score, finalTime);

          feedback.textContent = `Game Over! Your Score: ${score}/25 🏆`;
          feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
          feedback.classList.add('text-yellow-300');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.add('hidden');
          backToHome.classList.remove('hidden');
          viewStats.classList.remove('hidden');
          shareLink.classList.remove('hidden');

          while (answerResults.length < 5) answerResults.push(false);

          shareLink.innerHTML = "";
          const shareButtonsRow = document.createElement('div');
          shareButtonsRow.className = "share-buttons-row";
          shareButtonsRow.appendChild(clipboardBtn);
          shareButtonsRow.appendChild(smsBtn);
          shareLink.appendChild(shareButtonsRow);

          sharePreview.innerHTML = generateShareText(answerResults);
          shareLink.appendChild(sharePreview);

          clipboardBtn.onclick = function() {
            const textToCopy = generateClipboardText(answerResults);
            navigator.clipboard.writeText(textToCopy)
              .then(() => {
                clipboardBtn.textContent = "Copied!";
                setTimeout(() => { clipboardBtn.textContent = "Copy to Clipboard"; }, 1200);
              })
              .catch(() => {
                clipboardBtn.textContent = "Copy Failed";
                setTimeout(() => { clipboardBtn.textContent = "Copy to Clipboard"; }, 1200);
              });
          };

          smsBtn.href = generateSmsLink(answerResults);
        }
      }

      submitAnswer.addEventListener('click', () => {
        const guess = guessInput.value.trim().toLowerCase();
        const correctAnswer = questions[currentLevel - 1].answer.toLowerCase();

        feedback.classList.remove('text-red-500', 'text-green-500', 'text-yellow-400');
        let result = false;
        if (guess === correctAnswer) {
          score += 5;
          feedback.textContent = `Nailed it! +5 points! 🏀`;
          feedback.classList.add('text-green-500');
          submitAnswer.classList.add('hidden');
          guessInput.classList.add('hidden');
          nextLevel.classList.remove('hidden');
          stopTimer();
          result = true;
        } else {
          const distance = getLevenshteinDistance(guess, correctAnswer);
          if (distance <= 2 && guess.length > 0) {
            feedback.textContent = `So close! Try again, you're off by a letter or two!`;
            feedback.classList.add('text-yellow-400');
            guessInput.value = '';
          } else {
            feedback.textContent = `Swing and a miss! The answer was ${questions[currentLevel - 1].answer}.`;
            feedback.classList.add('text-red-500');
            submitAnswer.classList.add('hidden');
            guessInput.classList.add('hidden');
            nextLevel.classList.remove('hidden');
            stopTimer();
            result = false;
          }
        }
        answerResults.push(result);
        scoreDisplay.textContent = score;
      });

      guessInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitAnswer.click();
      });

      nextLevel.addEventListener('click', () => {
        moveToNextLevel();
      });

      viewStats.addEventListener('click', () => {
        displayStats();
      });

      closeStats.addEventListener('click', () => {
        statsModal.classList.add('hidden');
        if (currentLevel <= questions.length) {
          moveToNextLevel();
        }
      });

      loadLevel();
    }
  </script>
</body>
</html>
